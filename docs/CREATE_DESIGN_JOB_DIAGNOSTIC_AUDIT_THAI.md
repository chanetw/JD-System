# รายงานการตรวจสอบระบบเชิงลึก: โมดูลสร้างใบงานออกแบบ (Create Design Job)

**วันที่ตรวจสอบ:** 29 มกราคม 2026
**สถานะ:** วิกฤต (CRITICAL) - ระบบช้ามาก (High Latency) + ตรรกะการทำงานล้มเหลว (Logic Failure)
**ขอบเขต:** ตรวจสอบทั้งระบบ (หน้าบ้าน → หลังบ้าน → ฐานข้อมูล)
**ภาษา:** ไทย (Thai)

---

## บทสรุปผู้บริหาร (Executive Summary)

โมดูล **สร้างใบงานออกแบบ (Create Design Job)** กำลังประสบปัญหาสำคัญ 2 ประการที่เกี่ยวข้องกัน ซึ่งส่งผลกระทบต่อการใช้งานโดยตรง:

### **1. ปัญหาความล่าช้าของระบบ (High Latency & Performance Bottleneck)**
- **อาการ:** เมื่อเข้าหน้าสร้างใบงาน ระบบใช้เวลาโหลดนานมาก (8-15+ วินาที) กว่าแบบฟอร์มจะพร้อมใช้งาน
- **ผลกระทบ:** ประสบการณ์ของผู้ใช้ (UX) แย่มาก ผู้ใช้จะรู้สึกว่าระบบค้างหรือตอบสนองช้า
- **สาเหตุ:**
    1.  การเรียก API แบบเรียงลำดับ (Sequential) ทำให้ต้องรอโหลดทีละอย่าง
    2.  การดึงข้อมูลขนาดใหญ่เกินความจำเป็น (Oversized Payloads)
    3.  การคิวรีฐานข้อมูลซ้ำซ้อนและไม่มีประสิทธิภาพ (ขาด Database Index)

### **2. ปัญหาตรรกะการทำงานล้มเหลว (Logic Dependency Failure)**
- **อาการ:** เมื่อผู้ใช้เลือก "ประเภทงาน" (Job Type) แล้ว รายการย่อย (Job Type Items) ไม่แสดงผลออกมา
- **ผลกระทบ:** แบบฟอร์มทำงานไม่สมบูรณ์ ผู้ใช้ไม่สามารถระบุรายละเอียดงานย่อยได้ ทำให้สร้างงานไม่ได้ตามโฟลว์
- **สาเหตุ:** ความผิดพลาดในการสื่อสารระหว่าง Frontend และ Backend (API Structure Mismatch) โดย Frontend พยายามเรียกใช้ฟังก์ชันที่ไม่มีการรองรับจาก Backend จริง

---

## ส่วนที่ 1: วิเคราะห์สาเหตุ - ปัญหาความล่าช้า (Performance)

### **ประเด็นที่ 1.1: การเรียก API แบบรอคิว (Serial API Calls)**

**ตำแหน่ง:** `CreateJobPage.jsx` บรรทัด 111-145

**การทำงานปัจจุบัน:**
โค้ดสั่งให้โหลด `Master Data` ให้เสร็จก่อน *แล้วค่อย* เริ่มโหลด `Holidays` (วันหยุด)
```javascript
// ตัวอย่างโค้ดที่เป็นปัญหา
await api.getMasterData();  // ต้องรอตัวนี้เสร็จ (3-4 วินาที)
await api.getHolidays();    // ถึงจะเริ่มทำตัวนี้ (เสียเวลาเพิ่ม)
```

**ผลกระทบ:**
- ผู้ใช้ต้องรอนานขึ้น 2 เท่าโดยไม่จำเป็น เพราะข้อมูลทั้งสองส่วนแยกจากกัน ควรโหลดพร้อมกันได้
- เพิ่มเวลาโหลดรวมไปอีก 2.5 - 5 วินาที

### **ประเด็นที่ 1.2: การคิวรีฐานข้อมูลมีปัญหา N+1 (Backend Bottleneck)**

**ตำแหน่ง:** `master-data.js`

**การทำงานปัจจุบัน:**
Backend พยายามดึงข้อมูล `Job Types` พร้อมกับ `Job Type Items` ของทุกประเภทงานออกมาพร้อมกัน แต่ในฐานข้อมูลตาราง `JobTypeItem` **ไม่ได้ทำ Index** ไว้ที่ `jobTypeId`

**ผลกระทบ:**
- ฐานข้อมูลต้องไล่ค้นหาข้อมูลทั้งตาราง (Full Table Scan) ทุกครั้งที่มีการดึง Job Type
- ยิ่งข้อมูลเยอะ ระบบยิ่งช้า (ใช้เวลา 200-500ms เทียบกับปกติที่ควรใช้แค่ 10-20ms หากมี Index)

---

## ส่วนที่ 2: วิเคราะห์สาเหตุ - ปัญหาตรรกะ (Logic Failure)

### **ประเด็นที่ 2.1: รายการย่อยไม่ยอมโหลด (Items Not Populating)**

**อาการ:** เลือกประเภทงานแล้ว รายการย่อยเงียบหาย

**สาเหตุที่แท้จริง:**
ในไฟล์ `adminService.js` มีการประกาศฟังก์ชัน `getJobTypeItems` ไว้ แต่ข้างใน **Hardcode** ให้ส่งค่าว่างกลับมา!

```javascript
/* adminService.js */
getJobTypeItems: async (jobTypeId) => {
    // โปรแกรมเมอร์คนเก่าอาจจะแปะไว้ก่อนแล้วลืมทำต่อ
    return [];  // ← ปัญหาอยู่ตรงนี้! ส่ง Matrix ว่างกลับไปเสมอ
},
```

### **ประเด็นที่ 2.2: ข้อมูลมีอยู่แล้วแต่ไม่ได้ใช้ (Unused Data)**

**ข้อเท็จจริง:**
จริงๆ แล้ว API `getMasterData` ได้ส่งข้อมูลรายการย่อย (Job Items) แฝงมาให้อยู่แล้วในตัวแปร `jobTypes` แต่ Frontend กลับไม่ได้เขียนโค้ดให้ดึงข้อมูลส่วนนี้มาใช้ กลับไปพยายามเรียก API แยกอีกตัวที่ (ในตอนแรก) ยังไม่มีอยู่จริง

---

## ส่วนที่ 3: ข้อเสนอแนะทางเทคนิค (Recommendations)

### **1. แก้ไขปัญหาความล่าช้า (Performance Fixes)**

*   **Priority High:** ปรับ Frontend ให้เรียก API พร้อมกัน (Parallel Fetching) โดยใช้ `Promise.all`
*   **Priority Critical:** เพิ่ม Index ให้ฐานข้อมูล ในตาราง `JobTypeItem` เพื่อให้ค้นหาสินค้าตามประเภทได้เร็วขึ้น
    ```sql
    CREATE INDEX idx_jobtypeitems_jobtype_id ON "JobTypeItem"(jobTypeId);
    ```

### **2. แก้ไขปัญหาตรรกะ (Logic Fixes)**

*   **Priority Critical:** ต้องแก้ไข `adminService.js` ให้ทำงานถูกต้อง โดยมีทางเลือก 2 ทาง:
    1.  **ทางเลือก A (แนะนำ):** ดึงข้อมูลจาก Cache ที่มีอยู่แล้ว ไม่ต้องยิง Server ใหม่ (เร็วสุด)
    2.  **ทางเลือก B (ทำเพิ่ม):** สร้าง Endpoint ใหม่ `/api/job-types/:id/items` เพื่อให้ Frontend ยิงขอข้อมูลได้จริง

---

## ส่วนที่ 4: แผนการดำเนินการสำหรับนักพัฒนา (Implementation Plan)

1.  **แก้ Bug รายการย่อยหาย:**
    - แก้ไขไฟล์ `adminService.js` เปลี่ยน `return []` ให้เป็นการเรียก API จริง หรือ ดึงจาก Object `masterData`
2.  **เพิ่มความรวดเร็ว:**
    - รันคำสั่ง `npx prisma migrate` เพื่อเพิ่ม Index ใน Database
    - ปรับโค้ด `CreateJobPage.jsx` ให้ใช้ `Promise.all` ในการโหลดข้อมูลเริ่มต้น
3.  **ทดสอบ:**
    - ลองเข้าหน้า Create Job จับเวลาต้องโหลดไม่เกิน 2 วินาที
    - ลองเลือก Job Type แล้วดูว่ารายการย่อยขึ้นทันทีหรือไม่

---

## บทสรุป (Conclusion)

ปัญหาที่เกิดขึ้นเกิดจาก "หนี้ทางเทคนิค" (Technical Debt) ที่สะสมไว้ 2 จุด คือ Database ขาดการปรับจูน (Index) และ Frontend Logic ที่เขียนไม่สมบูรณ์ การแก้ไขตามแผนข้างต้นใช้เวลาไม่นาน (ประมาณ 30-45 นาที) แต่จะช่วยให้ระบบเร็วขึ้นอย่างเห็นได้ชัดและฟังก์ชันการทำงานกลับมาสมบูรณ์ครับ
