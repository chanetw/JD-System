// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../api-server/node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// ENUMS
// ========================================

enum Priority {
  low
  normal
  urgent
}

enum JobStatus {
  draft
  scheduled
  submitted
  pending_approval
  approved
  assigned
  in_progress
  rework
  rejected
  completed
  closed
}

enum ApprovalStatus {
  pending
  approved
  rejected
  returned
}

// ========================================
// MODELS
// ========================================

model Tenant {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(200)
  code      String   @unique @db.VarChar(50)
  subdomain String?  @unique @db.VarChar(100)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  users                User[]
  roles                Role[]
  userRoles            UserRole[]
  buds                 Bud[]
  departments          Department[]
  projects             Project[]
  jobTypes             JobType[]
  jobs                 Job[]
  // jobBriefs     JobBrief[]
  jobAttachments       JobAttachment[]
  jobDeliverables      JobDeliverable[]
  approvalFlows        ApprovalFlow[]
  approvals            Approval[]
  jobActivities        JobActivity[]
  jobComments          JobComment[]
  notifications        Notification[]
  holidays             Holiday[]
  mediaFiles           MediaFile[]
  auditLogs            AuditLog[]
  userScopeAssignments UserScopeAssignment[]
  budJobAssignments    BudJobAssignment[]

  @@map("tenants")
}

model User {
  id           Int     @id @default(autoincrement())
  tenantId     Int     @map("tenant_id")
  departmentId Int?    @map("department_id")
  email        String  @db.VarChar(255)
  passwordHash String  @map("password_hash") @db.VarChar(255)
  firstName    String  @map("first_name") @db.VarChar(100)
  lastName     String  @map("last_name") @db.VarChar(100)
  displayName  String? @map("display_name") @db.VarChar(100)
  avatarUrl    String? @map("avatar_url") @db.VarChar(500)

  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  // Registration Approval Workflow Fields
  status             String?   @default("APPROVED") @db.VarChar(50) // PENDING, APPROVED, REJECTED, INACTIVE
  registeredAt       DateTime? @map("registered_at")
  approvedAt         DateTime? @map("approved_at")
  approvedById       Int?      @map("approved_by")
  rejectionReason    String?   @map("rejection_reason") @db.Text
  lastLoginAt        DateTime? @map("last_login_at")
  mustChangePassword Boolean   @default(false) @map("must_change_password") // TRUE after admin generates password

  tenant     Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  department Department? @relation("UserDepartment", fields: [departmentId], references: [id])
  // approvedByUser User?    @relation("ApprovedByUser", fields: [approvedById], references: [id]) // TEMP
  // approvedUsers  User[]   @relation("ApprovedByUser") // TEMP

  // Relations
  userRoles            UserRole[]
  managedDepartments   Department[]           @relation("DepartmentManager")
  requestedJobs        Job[]                  @relation("RequesterJobs")
  assignedJobs         Job[]                  @relation("AssigneeJobs")
  closeRequestedJobs   Job[]                  @relation("CloseRequestedJobs")
  closedJobs           Job[]                  @relation("ClosedJobs")
  completedJobs        Job[]                  @relation("CompletedJobs")
  uploadedAttachments  JobAttachment[]
  uploadedDeliverables JobDeliverable[]
  approvals            Approval[]
  activityLogs         ActivityLog[]          @relation("ActivityLogUser")
  comments             JobComment[]
  notifications        Notification[]
  auditLogs            AuditLog[]
  assignedProjects     ProjectJobAssignment[] @relation("AssignedProjects")
  assignedBuds         BudJobAssignment[]     @relation("AssignedBuds")
  mediaFiles           MediaFile[]
  passwordResets       PasswordResetRequest[]
  jobActivities        JobActivity[]
  // V1 Extended: Auto-assign relation
  autoAssignFlows      ApprovalFlow[]         @relation("FlowAutoAssign")
  // Scope assignments (project/bud level access)
  scopeAssignments     UserScopeAssignment[]

  @@unique([tenantId, email])
  @@index([departmentId])
  @@map("users")
}

model Role {
  id          Int      @id @default(autoincrement())
  tenantId    Int      @map("tenant_id")
  name        String   @db.VarChar(50)
  displayName String   @map("display_name") @db.VarChar(100)
  description String?  @db.Text
  permissions Json?    @default(dbgenerated("'{\"read\": true, \"create\": false, \"update\": false, \"delete\": false}'::jsonb")) // For V2 auth RBAC
  createdAt   DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // userRoles    UserRole[] // Relation removed because UserRole doesnt reference Role anymore

  @@unique([tenantId, name])
  @@map("roles")
}

model UserRole {
  id         Int       @id @default(autoincrement())
  tenantId   Int       @map("tenant_id")
  userId     Int       @map("user_id")
  roleName   String?   @map("role_name") @db.VarChar(100)
  assignedBy Int?      @map("assigned_by")
  assignedAt DateTime? @map("assigned_at")
  isActive   Boolean   @default(true) @map("is_active")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime? @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_roles")
}

model Bud {
  id          Int      @id @default(autoincrement())
  tenantId    Int      @map("tenant_id")
  name        String   @db.VarChar(100)
  code        String   @db.VarChar(20)
  description String?  @db.Text
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  // updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  tenant            Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  departments       Department[]
  projects          Project[]
  budJobAssignments BudJobAssignment[]

  @@unique([tenantId, code])
  @@map("buds")
}

model Project {
  id           Int      @id @default(autoincrement())
  tenantId     Int      @map("tenant_id")
  name         String   @db.VarChar(200)
  code         String   @db.VarChar(50)
  budId        Int      @map("bud_id")
  departmentId Int?     @map("department_id")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")

  tenant         Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  bud            Bud                    @relation(fields: [budId], references: [id])
  department     Department?            @relation(fields: [departmentId], references: [id])
  jobs           Job[]
  jobAssignments ProjectJobAssignment[]
  mediaFiles     MediaFile[]
  approvalFlows  ApprovalFlow[]

  @@unique([tenantId, code])
  @@index([budId])
  @@index([departmentId])
  @@map("projects")
}

model JobType {
  id             Int     @id @default(autoincrement())
  tenantId       Int     @map("tenant_id")
  name           String  @db.VarChar(100)
  slaWorkingDays Int     @map("sla_days")
  description    String? @db.Text
  isActive       Boolean @default(true) @map("is_active")

  // Auto-Sequence / Job Chain
  nextJobTypeId Int?     @map("next_job_type_id")
  nextJobType   JobType? @relation("JobChain", fields: [nextJobTypeId], references: [id])
  prevJobTypes  JobType[] @relation("JobChain")

  icon        String?  @db.VarChar
  colorTheme  String?  @map("color_theme") @db.VarChar
  attachments String[] @default([])

  tenant            Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  jobs              Job[]
  jobTypeItems      JobTypeItem[]
  jobAssignments    ProjectJobAssignment[]
  budJobAssignments BudJobAssignment[]
  approvalFlows     ApprovalFlow[]

  @@index([tenantId])
  @@map("job_types")
}

model Job {
  id        Int @id @default(autoincrement())
  tenantId  Int @map("tenant_id")
  projectId Int @map("project_id")
  jobTypeId Int @map("job_type_id")

  // Design Brief
  djId        String  @unique @map("dj_id") @db.VarChar(50)
  subject     String  @db.VarChar(255)
  objective   String? @db.Text
  description String? @db.Text
  headline    String? @db.VarChar(255)
  subHeadline String? @map("sub_headline") @db.VarChar(255)
  briefLink   String? @map("brief_link") @db.VarChar(1000)
  briefFiles  Json?   @default("[]") @map("brief_files")

  // Status & Priority
  status   String @default("draft") @db.VarChar(50)
  priority String @default("normal") @db.VarChar(20)

  // People
  requesterId      Int  @map("requester_id")
  assigneeId       Int? @map("assignee_id")
  closeRequestedBy Int? @map("close_requested_by")
  closedBy         Int? @map("closed_by")
  completedBy      Int? @map("completed_by")

  // Parent-Child Relationship
  isParent    Boolean @default(false) @map("is_parent")
  parentJobId Int?    @map("parent_job_id")

  // Dates
  dueDate          DateTime? @map("due_date") @db.Timestamptz
  assignedAt       DateTime? @map("assigned_at") @db.Timestamptz
  startedAt        DateTime? @map("started_at") @db.Timestamptz
  completedAt      DateTime? @map("completed_at") @db.Timestamptz

  // Job Chain / Dependency
  predecessorId Int?      @map("predecessor_id")
  slaDays       Int?      @default(0) @map("sla_days") // Store original SLA for recalculation

  predecessor Job?  @relation("JobDependency", fields: [predecessorId], references: [id])
  successors  Job[] @relation("JobDependency")
  closeRequestedAt DateTime? @map("close_requested_at") @db.Timestamptz
  closedAt         DateTime? @map("closed_at") @db.Timestamptz
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz
  // updatedAt         DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // JSONB Fields
  autoApprovedLevels Json? @default("[]") @map("auto_approved_levels")
  finalFiles         Json? @default("[]") @map("final_files")

  // Relations
  tenant          Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project         Project @relation(fields: [projectId], references: [id])
  jobType         JobType @relation(fields: [jobTypeId], references: [id])
  requester       User    @relation("RequesterJobs", fields: [requesterId], references: [id])
  assignee        User?   @relation("AssigneeJobs", fields: [assigneeId], references: [id])
  closeRequester  User?   @relation("CloseRequestedJobs", fields: [closeRequestedBy], references: [id])
  closedByUser    User?   @relation("ClosedJobs", fields: [closedBy], references: [id])
  completedByUser User?   @relation("CompletedJobs", fields: [completedBy], references: [id])

  // Parent-Child Self-Relation
  parentJob  Job?  @relation("ParentChildJobs", fields: [parentJobId], references: [id], onDelete: SetNull)
  childJobs  Job[] @relation("ParentChildJobs")

  jobItems        DesignJobItem[]
  attachments     JobAttachment[]
  deliverables    JobDeliverable[]
  approvals       Approval[]
  activityLogs    ActivityLog[]    @relation("JobActivityLogs")
  comments        JobComment[]
  mediaFiles      MediaFile[]
  slaShiftLogs    SlaShiftLog[]    @relation("SlaShiftLogs")
  urgentJobShifts SlaShiftLog[]    @relation("UrgentJobShifts")
  jobActivities   JobActivity[]

  @@unique([tenantId, djId])
  @@index([tenantId])
  @@index([status])
  @@index([requesterId])
  @@index([assigneeId])
  @@index([dueDate])
  @@index([createdAt])
  @@index([parentJobId]) // Parent-Child lookup
  // ⚡ Performance: Composite Indexes for common queries
  @@index([tenantId, status, dueDate]) // Dashboard: งานตาม status และ due date
  @@index([assigneeId, status]) // My Queue: งานของฉันตาม status
  @@index([requesterId, createdAt]) // My Requests: งานที่ฉันขอ เรียงตามวันที่
  @@map("jobs")
}

// model JobBrief {
//   id           Int      @id @default(autoincrement())
//   tenantId     Int      @map("tenant_id")
//   jobId        Int      @unique @map("job_id")
//   objective    String   @db.Text
//   headline     String?  @db.VarChar(500)
//   subHeadline  String?  @map("sub_headline") @db.VarChar(500)
//   sellingPoints Json?   @map("selling_points")
//   price        String?  @db.VarChar(200)
//   referenceUrl String?  @map("reference_url") @db.VarChar(1000)
//   createdAt    DateTime @default(now()) @map("created_at")
//   updatedAt    DateTime @default(now()) @updatedAt @map("updated_at")
// 
//   tenant       Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
//   job          DesignJob @relation(fields: [jobId], references: [id], onDelete: Cascade)
// 
//   @@map("job_briefs")
// }

model JobAttachment {
  id             Int      @id @default(autoincrement())
  tenantId       Int      @map("tenant_id")
  jobId          Int      @map("job_id")
  fileName       String   @map("file_name") @db.VarChar(500)
  filePath       String   @map("file_path") @db.VarChar(1000)
  fileSize       BigInt?  @map("file_size")
  fileType       String?  @map("file_type") @db.VarChar(100)
  attachmentType String?  @map("attachment_type") @db.VarChar(100)
  uploadedBy     Int      @map("uploaded_by")
  createdAt      DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  job    Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [uploadedBy], references: [id])

  @@map("job_attachments")
}

model JobDeliverable {
  id         Int      @id @default(autoincrement())
  tenantId   Int      @map("tenant_id")
  jobId      Int      @map("job_id")
  version    Int      @default(1)
  fileName   String   @map("file_name") @db.VarChar(500)
  filePath   String   @map("file_path") @db.VarChar(1000)
  fileSize   BigInt?  @map("file_size")
  fileType   String?  @map("file_type") @db.VarChar(100)
  uploadedBy Int      @map("uploaded_by")
  isFinal    Boolean  @default(false) @map("is_final")
  createdAt  DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  job    Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [uploadedBy], references: [id])

  @@map("job_deliverables")
}

model ApprovalFlow {
  id        Int  @id @default(autoincrement())
  tenantId  Int  @map("tenant_id")
  projectId Int? @map("project_id")

  // V1 Extended: Job Type specific flow support
  jobTypeId        Int?    @map("job_type_id")
  level            Int     @default(0) // Level field (legacy, kept for DB compatibility)
  skipApproval     Boolean @default(false) @map("skip_approval")
  autoAssignType   String? @map("auto_assign_type") @db.VarChar(50)
  autoAssignUserId Int?    @map("auto_assign_user_id")

  name          String    @db.VarChar(200)
  description   String?   @db.Text
  conditions    Json?
  approverSteps Json?     @map("approver_steps")
  allowOverride Boolean   @default(false) @map("allow_override")
  effectiveFrom DateTime? @map("effective_from") @db.Date
  effectiveTo   DateTime? @map("effective_to") @db.Date
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at")

  tenant         Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project        Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  jobType        JobType? @relation(fields: [jobTypeId], references: [id], onDelete: Cascade)
  autoAssignUser User?    @relation("FlowAutoAssign", fields: [autoAssignUserId], references: [id], onDelete: SetNull)

  @@unique([projectId, jobTypeId])
  @@index([tenantId])
  @@index([projectId])
  @@index([projectId, jobTypeId])
  @@map("approval_flows")
}

// ========================================
// Approval Flow V2 - REMOVED
// ========================================
// V2 Template System has been removed in favor of V1 Extended
// See migration: 016_extend_v1_remove_v2_approval_flow.sql
// Archive tables: approval_flow_templates_archive, etc.

model Approval {
  id            Int            @id @default(autoincrement())
  tenantId      Int            @map("tenant_id")
  jobId         Int            @map("job_id")
  stepNumber    Int            @map("step_number")
  approverId    Int            @map("approver_id")
  status        ApprovalStatus @default(pending)
  comment       String?        @db.Text
  approvedAt    DateTime?      @map("approved_at")
  approvalToken String?        @map("approval_token") @db.VarChar(64)
  ipAddress     String?        @map("ip_address") @db.VarChar(45) // IPv6 support
  userAgent     String?        @map("user_agent") @db.Text
  createdAt     DateTime       @default(now()) @map("created_at")

  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  job      Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)
  approver User   @relation(fields: [approverId], references: [id])

  @@index([jobId, approverId])
  @@index([status, createdAt])
  @@index([jobId, status])
  @@index([tenantId, status])
  @@map("approvals")
}

model JobActivity {
  id           Int      @id @default(autoincrement())
  tenantId     Int      @map("tenant_id")
  jobId        Int      @map("job_id")
  userId       Int?     @map("user_id")
  activityType String   @map("activity_type") @db.VarChar(50)
  description  String?  @db.Text
  metadata     Json?
  createdAt    DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  job    Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id])

  @@index([jobId, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@index([jobId, activityType])
  @@index([tenantId, createdAt(sort: Desc)])
  @@map("job_activities")
}

model JobComment {
  id        Int      @id @default(autoincrement())
  tenantId  Int      @map("tenant_id")
  jobId     Int      @map("job_id")
  userId    Int      @map("user_id")
  comment   String   @db.Text
  mentions  Json?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  job    Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id])

  @@index([jobId, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@index([tenantId, jobId])
  @@map("job_comments")
}

model Notification {
  id        Int      @id @default(autoincrement())
  tenantId  Int      @map("tenant_id")
  userId    Int      @map("user_id")
  type      String   @db.VarChar(50)
  title     String   @db.VarChar(500)
  message   String?  @db.Text
  link      String?  @db.VarChar(500)
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  logs   NotificationLog[]

  @@map("notifications")
}

// ========================================
// Missing Models (Newly Added)
// ========================================

model Department {
  id          Int      @id @default(autoincrement())
  tenantId    Int      @map("tenant_id")
  budId       Int?     @map("bud_id")
  name        String   @db.VarChar(255)
  code        String   @db.VarChar(50)
  managerId   Int?     @map("manager_id")
  description String?  @db.Text
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  bud      Bud?      @relation(fields: [budId], references: [id])
  manager  User?     @relation("DepartmentManager", fields: [managerId], references: [id], onDelete: SetNull)
  users    User[]    @relation("UserDepartment")
  projects Project[]

  @@index([tenantId])
  @@index([budId])
  @@index([managerId])
  @@map("departments")
}

model DesignJobItem {
  id            Int     @id @default(autoincrement())
  jobId         Int     @map("job_id")
  jobTypeItemId Int?    @map("job_type_item_id")
  name          String  @db.VarChar(255)
  quantity      Int     @default(1)
  status        String  @default("pending") @db.VarChar(50)
  filePath      String? @map("file_path") @db.Text

  job         Job          @relation(fields: [jobId], references: [id], onDelete: Cascade)
  jobTypeItem JobTypeItem? @relation(fields: [jobTypeItemId], references: [id])

  @@index([jobId])
  @@index([jobTypeItemId])
  @@map("design_job_items")
}

model JobTypeItem {
  id          Int      @id @default(autoincrement())
  jobTypeId   Int      @map("job_type_id")
  name        String   @db.VarChar(255)
  defaultSize String?  @map("default_size") @db.VarChar(100)
  isRequired  Boolean  @default(false) @map("is_required")
  sortOrder   Int?     @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz

  jobType  JobType         @relation(fields: [jobTypeId], references: [id], onDelete: Cascade)
  jobItems DesignJobItem[]

  @@index([jobTypeId]) // Added for performance optimization
  @@map("job_type_items")
}

model ActivityLog {
  id        Int      @id @default(autoincrement())
  jobId     Int      @map("job_id")
  userId    Int?     @map("user_id")
  action    String   @db.VarChar(50)
  message   String?  @db.Text
  detail    Json?
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  job  Job   @relation("JobActivityLogs", fields: [jobId], references: [id], onDelete: Cascade)
  user User? @relation("ActivityLogUser", fields: [userId], references: [id])

  @@index([jobId])
  @@index([userId])
  @@index([createdAt])
  @@map("activity_logs")
}

model AuditLog {
  id        Int      @id @default(autoincrement())
  tenantId  Int      @map("tenant_id")
  userId    Int?     @map("user_id")
  action    String   @db.VarChar(100)
  entityType String   @map("entity_type") @db.VarChar(100) // Changed from tableName/table_name
  entityId   Int?     @map("entity_id") // Changed from recordId/record_id
  oldValues  Json?    @map("old_values") // Changed from oldValue/old_value
  newValues  Json?    @map("new_values") // Changed from newValue/new_value
  userIp     String?  @map("user_ip") // Changed from ipAddress/ip_address
  userAgent  String?  @map("user_agent") @db.Text
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

model NotificationLog {
  id             Int       @id @default(autoincrement())
  notificationId Int       @map("notification_id")
  status         String    @db.VarChar(50)
  sentAt         DateTime? @map("sent_at") @db.Timestamptz
  error          String?   @db.Text
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz

  notification Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  @@index([notificationId])
  @@map("notification_logs")
}

model ProjectJobAssignment {
  id         Int      @id @default(autoincrement())
  projectId  Int      @map("project_id")
  jobTypeId  Int      @map("job_type_id")
  assigneeId Int?     @map("assignee_id")
  isActive   Boolean  @default(true) @map("is_active")
  priority   Int      @default(100) // Project-level has highest priority
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  project  Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  jobType  JobType @relation(fields: [jobTypeId], references: [id], onDelete: Cascade)
  assignee User?   @relation("AssignedProjects", fields: [assigneeId], references: [id], onDelete: SetNull)

  @@unique([projectId, jobTypeId])
  @@index([projectId])
  @@index([jobTypeId])
  @@index([assigneeId])
  @@index([assigneeId, isActive])
  @@map("project_job_assignments")
}

model BudJobAssignment {
  id         Int      @id @default(autoincrement())
  tenantId   Int      @map("tenant_id")
  budId      Int      @map("bud_id")
  jobTypeId  Int      @map("job_type_id")
  assigneeId Int?     @map("assignee_id")
  isActive   Boolean  @default(true) @map("is_active")
  priority   Int      @default(50) // BUD-level has lower priority than project-level
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  tenant   Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  bud      Bud     @relation(fields: [budId], references: [id], onDelete: Cascade)
  jobType  JobType @relation(fields: [jobTypeId], references: [id], onDelete: Cascade)
  assignee User?   @relation("AssignedBuds", fields: [assigneeId], references: [id], onDelete: SetNull)

  @@unique([tenantId, budId, jobTypeId])
  @@index([budId])
  @@index([jobTypeId])
  @@index([assigneeId])
  @@index([assigneeId, isActive])
  @@index([tenantId])
  @@map("bud_job_assignments")
}

model SlaShiftLog {
  id              Int      @id @default(autoincrement())
  jobId           Int      @map("job_id")
  urgentJobId     Int?     @map("urgent_job_id")
  originalDueDate DateTime @map("original_due_date") @db.Timestamptz
  newDueDate      DateTime @map("new_due_date") @db.Timestamptz
  shiftDays       Int      @map("shift_days")
  reason          String?  @db.Text
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz

  job       Job  @relation("SlaShiftLogs", fields: [jobId], references: [id], onDelete: Cascade)
  urgentJob Job? @relation("UrgentJobShifts", fields: [urgentJobId], references: [id], onDelete: NoAction)

  @@index([jobId])
  @@index([urgentJobId])
  @@map("sla_shift_logs")
}

model PasswordResetRequest {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  token     String   @unique @db.VarChar(255)
  expiresAt DateTime @map("expires_at") @db.Timestamptz
  isUsed    Boolean  @default(false) @map("is_used")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("password_reset_requests")
}

model Holiday {
  id          Int      @id @default(autoincrement())
  tenantId    Int      @map("tenant_id")
  name        String   @db.VarChar(200)
  date        DateTime @db.Date
  isRecurring Boolean  @default(false) @map("is_recurring")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("holidays")
}

model MediaFile {
  id            Int      @id @default(autoincrement())
  tenantId      Int      @map("tenant_id")
  jobId         Int?     @map("job_id")
  projectId     Int?     @map("project_id")
  fileName      String   @map("file_name") @db.VarChar(500)
  filePath      String   @map("file_path") @db.VarChar(1000)
  fileSize      BigInt?  @map("file_size")
  fileType      String?  @map("file_type") @db.VarChar(100)
  mimeType      String?  @map("mime_type") @db.VarChar(100)
  thumbnailPath String?  @map("thumbnail_path") @db.VarChar(1000)
  uploadedBy    Int      @map("uploaded_by")
  downloadCount Int      @default(0) @map("download_count")
  createdAt     DateTime @default(now()) @map("created_at")

  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  job     Job?     @relation(fields: [jobId], references: [id], onDelete: SetNull)
  project Project? @relation(fields: [projectId], references: [id])
  user    User     @relation(fields: [uploadedBy], references: [id])

  @@map("media_files")
}

model UserScopeAssignment {
  id         Int      @id @default(autoincrement())
  tenantId   Int      @map("tenant_id")
  userId     Int      @map("user_id")
  roleType   String   @map("role_type") @db.VarChar(100)
  scopeLevel String   @map("scope_level") @db.VarChar(50)
  scopeId    Int?     @map("scope_id")
  scopeName  String?  @map("scope_name") @db.VarChar(255)
  assignedBy Int?     @map("assigned_by")
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tenantId])
  @@map("user_scope_assignments")
}
